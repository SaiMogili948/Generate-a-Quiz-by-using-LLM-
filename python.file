from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from sqlalchemy import create_engine, Column, Integer, Text, JSON
from sqlalchemy.orm import declarative_base, sessionmaker
import requests
from bs4 import BeautifulSoup

DATABASE_URL = "postgresql://postgres:postgres@localhost:5432/wikiquiz"

engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()

class Quiz(Base):
    __tablename__ = "quizzes"
    id = Column(Integer, primary_key=True, index=True)
    url = Column(Text, unique=True, nullable=False)
    title = Column(Text, nullable=False)
    data = Column(JSON, nullable=False)

Base.metadata.create_all(bind=engine)

app = FastAPI()

class QuizRequest(BaseModel):
    url: str

def scrape_wikipedia(url: str):
    r = requests.get(url, timeout=10)
    if r.status_code != 200:
        raise HTTPException(status_code=400, detail="Invalid Wikipedia URL")
    soup = BeautifulSoup(r.text, "html.parser")
    title = soup.find("h1").get_text(strip=True)
    paragraphs = soup.select("p")
    content = " ".join(p.get_text(strip=True) for p in paragraphs[:15])
    return title, content

@app.post("/generate")
def generate_quiz(req: QuizRequest):
    db = SessionLocal()
    cached = db.query(Quiz).filter(Quiz.url == req.url).first()
    if cached:
        return cached.data

    title, content = scrape_wikipedia(req.url)

    data = {
        "url": req.url,
        "title": title,
        "summary": content[:300],
        "quiz": [
            {
                "question": "What is the main topic of this article?",
                "options": ["History", "Biography", "Science", "Technology"],
                "answer": "Biography",
                "difficulty": "easy",
                "explanation": "Derived from the article introduction."
            }
        ],
        "related_topics": ["Computer science", "History"]
    }

    quiz = Quiz(url=req.url, title=title, data=data)
    db.add(quiz)
    db.commit()
    db.refresh(quiz)
    return data

@app.get("/history")
def history():
    db = SessionLocal()
    return [{"id": q.id, "url": q.url, "title": q.title} for q in db.query(Quiz).all()]

@app.get("/history/{quiz_id}")
def history_detail(quiz_id: int):
    db = SessionLocal()
    quiz = db.query(Quiz).filter(Quiz.id == quiz_id).first()
    if not quiz:
        raise HTTPException(status_code=404, detail="Quiz not found")
    return quiz.data

